# フロントエンド開発ログ

## 2025-12-07: Azure App Service デプロイと Next.js 15 対応

### 概要
Next.js 15 (App Router) アプリケーションを Azure App Service (Linux) にデプロイするための環境構築とトラブルシューティングを実施。

### 実施内容と解決した課題

1.  **Next.js 15 の破壊的変更への対応**
    *   **課題:** ビルド時に `TypeError: Cannot destructure property 'id' of 'e' as it is undefined.` や `useSearchParams() should be wrapped in a suspense boundary` といったエラーが発生。
    *   **原因:** Next.js 15 から `params` や `searchParams` が Promise に変更されたため、非同期でのアクセスが必要になった。また、静的生成時に `useSearchParams` を使うコンポーネントは `Suspense` でラップする必要がある。
    *   **対応:**
        *   `src/app/customers/check/page.jsx`: `searchParams` を `await` するように修正。
        *   `src/app/customers/create/confirm/page.jsx`, `src/app/customers/delete/[id]/confirm/page.jsx`: `useSearchParams` を使用するロジックを子コンポーネントに切り出し、`<Suspense>` でラップするように修正。

2.  **Azure App Service へのデプロイ構成 (Standalone Mode)**
    *   **課題:** デプロイ後、Azure上で `.next` ディレクトリが見つからない、またはパス解決ができず `MODULE_NOT_FOUND` エラーで起動しない。
    *   **原因:** 通常のビルド成果物ではなく、Azureに適した Standalone モードを使用する必要があった。また、Azure の Oryx ビルドプロセスがデプロイされたファイルを上書き・削除していた。
    *   **対応:**
        *   `next.config.js` に `output: 'standalone'` を追加。
        *   GitHub Actions で `package: release.zip` によるZipデプロイを採用し、`.next` フォルダ構造を維持。
        *   `SCM_DO_BUILD_DURING_DEPLOYMENT=false` を設定し、Azure側の自動ビルドを無効化。
        *   GitHub Actions で `startup-command: node server.js` を明示的に指定。

3.  **環境クリーンアップ**
    *   **課題:** 設定を変更しても、過去のビルド成果物（`node_modules.tar.gz` 等）が残り続け、起動エラーが解消しなかった。
    *   **対応:** SSH でサーバーに入り、`/home/site/wwwroot` 内の不要ファイルを全削除して環境をリセット。

### 結果
*   GitHub Actions からの自動デプロイが成功。
*   Azure App Service 上で `node server.js` によりアプリケーションが正常に起動。
*   バックエンドとの通信も正常に行われていることを確認。

---
